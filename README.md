- [Общие требования](#общие-требования)
- [Абстрактная схема взаимодействия с системой](#абстрактная-схема-взаимодействия-с-системой)
- [Технологии](#технологии)
- [Архитектуры проекта](#архитектуры-проекта)
- [Auth Service](#auth-service)
    - [Архитектура](#архитектура)
    - [REST эндпоинты](#rest-эндпоинты)
    - [RabbitMQ подписки](#rabbitmq-подписки)
- [Planner Service](#planner-service)
    - [Архитектура](#архитектура-1)
    - [REST эндпоинты](#rest-эндпоинты-1)
- [Запуск проекта](#запуск-проекта)

## Общие требования

Необходимо реализовать проект ежедневника с инфраструктурой построенной на docker-compose.

Пользователю будет доступен HTTP API со следующими бизнес требованиями:

- Регистрация и аутентификация пользователей;
- Добавление, изменение, завершение, удаление и получение списка задач;

<br><br>

## Абстрактная схема взаимодействия с системой

Ниже представлена абстрактная бизнес-логика взаимодействия пользователя с системой:

1. Пользователь регистрируется в системе;
2. После регистрации, пользователь аутентифицируется в системе;
3. При необходимости пользователь может сменить пароль;
4. Пользователь добавляет задачу в планировщик;
5. Пользователь может посмотреть свои задачи на сегодня, на неделю, просроченные и бессрочные и завершенные.
6. При необходимости пользователь может изменить задачу;
7. Пользователь может завершить задачу, которая попадёт в архив.

<br><br>

## Технологии

- **Nginx**. Базовый HTTP роутинг;
- **Golang**. Основной язык разработки;
- **RabbitMQ**. Брокер сообщений для внутреннего меж-сервисного взаимодействия;
- **PosrgreSQL**. База данных.

<br><br>

## Архитектуры проекта

Было принято решение выбрать Event-Driven микросервисную архитектуру без использования API Gateway.

```mermaid
flowchart LR
    user[User]
    nginx[NGINX]
    authService[Auth Service]
    plannerService[Planner Service]
    rmq(RabbitMQ)
    user --> nginx
    nginx --> authService
    nginx --> plannerService
    authService <-.-> rmq
    plannerService <-.-> rmq
```

Для общения с клиентом, сервисы будут предоставлять http ендпоинты. В качестве роутера выступает `nginx`.

Для общения между микросервисами используется брокер сообщений `RabbitMQ`.

<br><br>

## Auth Service

Сервис регистрации, аутентификации пользователя.
В этом сервисе также реализован механизм валидации JWT токена для других сервисов.

#### Регистрация

После успешной валидации отправленных данных, в базу сохраняется пользователь.
Пароль предварительно хэшируется\шифруется, а не хранится в базе в открытом виде.

#### Аутентификация

Отправляется запрос для получения JWT токена, сроком жизни в одни сутки.
По истечению срока, токен перестает действовать и требуется повторная авторизация.

#### Архитектура

В качестве архитектуры, была выбрана вариация гексоганальной.

```mermaid
flowchart LR
    subgraph controller[Controller]
        direction TB
        rest(REST)
        rmqConsumer(RabbitMQ)
    end

    subgraph service[Service]
        direction TB
        accountService(Account)
        jwtService(JWT)
    end

    subgraph repository[Repository]
        direction TB
        psql[(PostgreSQL)]
    end

    rest & rmqConsumer --> service
    service -.-> repository 
```

- В качестве входных портов используется слой контроллеров.
    - REST для получения внешних запросов от клиента;
    - RabbitMQ для получения внутренних запросов от других микросервисов.

- В качестве инфраструктуры используется слой сервисов.

- В качестве выходных портов используется слой репозиториев и адаптеров.
    - Репозиторий PostgreSQL для хранения постоянного хранения данных;
    - Адаптер Redis для кеширования валидированных ранее JWT токенов.

#### REST эндпоинты

- `post` `/auth/register` Регистрация аккаунта с хешированием\шифрованием пароля
- `post` `/auth/change_password` Смена пароля
- `post` `/auth/login` Аутентификация пары логин-пароль и генерация JWT токена.

#### RabbitMQ подписки

- `auth.jwt.validation` Валидация токена JWT.

<br><br>

## Planner Service

Сервис работы с задачами внутри планировщика. Доступны следующие функции:

- Добавление задачи;
- Изменение задачи;
- Получение списка задач на сегодня;
- Получение списка задач на неделю;
- Получение списка задач без даты выполнения;
- Получение списка просроченных задач;
- Получение списка задач в архиве.

#### Архитектура

В качестве архитектуры, была выбрана вариация гексоганальной.

```mermaid
flowchart LR
    subgraph controller[Controller]
        direction TB
        rest(REST)
    end

    subgraph service[Service]
        direction TB
        plannerService(Planner)
    end

    subgraph repository[Repository]
        direction TB
        psql[(PostgreSQL)]
    end

    subgraph adapter[Adapter]
        direction TB
        rmqPublisher(RabbitMQ)
    end

    rest --> service
    service -.-> repository & adapter
```

- В качестве входных портов используется слой контроллеров.
  Для этого сервиса предусмотрен только REST для получения внешних запросов от клиента.

- В качестве инфраструктуры используется слой сервисов.

- В качестве выходных портов используется слой репозиториев и адаптеров.
    - Репозиторий PostgreSQL для хранения постоянного хранения данных
    - Адаптер RabbitMQ для запроса данных из другого микросервиса

#### REST эндпоинты

- `post` `/planner` Добавление задачи
- `get` `/planner/{id}` Получение задачи по ID
- `get` `/planner/today` Получение списка задач на сегодня
- `get` `/planner/week` Получение списка задач на неделю
- `get` `/planner/undated` Получение списка бессрочных задач
- `get` `/planner/overdue` Получение списка просроченных задач
- `get` `/planner/archive` Получение задач в архиве
- `patch` `/planner/{id}` Изменение задачи
- `patch` `/planner/{id}/done` Завершение задачи и добавление её в архив
- `patch` `/planner/{id}/due_date` Изменяет время выполнения
- `delete` `/planner/{id}` Удаление задачи

<br><br>

## Запуск проекта

Для удобного запуска в *nix системах был добавлен Makefile.
Ниже будет приведен список доступных команд.

| Команда             | Описание                                  |
|---------------------|-------------------------------------------|
| `make start-dev`    | Запуск проекта в Development режиме       |
| `make start-prod`   | Запуск проекта в Production режиме        |
| `make stop`         | Останавливает все сервисы                 |
| `make lint`         | Линтинг всего проекта                     |
| `make install-deps` | Устанавливает все необходимые зависимости |

Также для запуска проекта потребуется создать файл `env/.env`.
Шаблон файла можно найти по пути `env/.env.example`.